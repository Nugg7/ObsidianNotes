### `NLog`
---
This is a library that we can get from the `NuGet packet manager` by searching for: `NLog.Web.AspNetCore`.
#### Configuration
To use `NLog` we need to configure it first, through the configuration file that we will create as `nlog.config`. The template that we can use as an example is in the documentation:

```xml
<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwConfigExceptions="true"
      internalLogLevel="Info"
      internalLogFile="c:\temp\internal-nlog-AspNetCore.txt">

  <!-- enable asp.net core layout renderers -->
  <extensions>
    <add assembly="NLog.Web.AspNetCore"/>
  </extensions>

  <!-- the targets to write to -->
  <targets>
    <!-- File Target for all log messages with basic details -->
    <target xsi:type="File" name="allfile" fileName="c:\temp\nlog-AspNetCore-all-${shortdate}.log"
            layout="${longdate}|${event-properties:item=EventId:whenEmpty=0}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}" />

    <!-- File Target for own log messages with extra web details using some ASP.NET core renderers -->
    <target xsi:type="File" name="ownFile-web" fileName="c:\temp\nlog-AspNetCore-own-${shortdate}.log"
            layout="${longdate}|${event-properties:item=EventId:whenEmpty=0}|${level:uppercase=true}|${logger}|${message} ${exception:format=tostring}|url: ${aspnet-request-url}|action: ${aspnet-mvc-action}" />

    <!--Console Target for hosting lifetime messages to improve Docker / Visual Studio startup detection -->
    <target xsi:type="Console" name="lifetimeConsole" layout="${MicrosoftConsoleLayout}" />
  </targets>

  <!-- rules to map from logger name to target -->
  <rules>
    <!-- All logs, including from Microsoft -->
    <logger name="*" minlevel="Trace" writeTo="allfile" />

    <!-- Suppress output from Microsoft framework when non-critical -->
    <logger name="System.*" finalMinLevel="Warn" />
    <logger name="Microsoft.*" finalMinLevel="Warn" />
    <!-- Keep output from Microsoft.Hosting.Lifetime to console for fast startup detection -->
    <logger name="Microsoft.Hosting.Lifetime*" finalMinLevel="Info" writeTo="lifetimeConsole" />

    <logger name="*" minLevel="Trace" writeTo="ownFile-web" />
  </rules>
</nlog>
```
#### Set up
Now after customizing our config file, all we have to do to start using this library is:
- Import it
- Use it in the code

```cs
using NLog;
using NLog.Web; // don't actually know if this one is needed
```
#### Functionalities
With `NLog` we are able to log these elements:
- Trace - Detailed Log
- Debug - Debugging Information
- Info - Info Message
- Warning - Warning Messages
- Error - Error Messages
- Fatal - Big Errors, which needs attention

Targets:
- Files - log into file 
- Database - it can work with SQL servers
- Console - we can also display the log in the console
- Email - we can also email the log messages

For console and file logging, all we need is to change the values accordingly in the config file with the path of the file if we're using that.

But for Emails we need:

| **Type**           | **Mail**                                       |
| ------------------ | ---------------------------------------------- |
| Subject            | Could be whatever you want                     |
| To                 | To whom you will send email                    |
| From               | Sending of email                               |
| Body               | layout (Message you want to display  in email) |
| enableSSl          | For secure email                               |
| SmtpAuthentication | (None, Basic, Ntlm)                            |
| SmtpUserName       | Username (from email)                          |
| SmtpPassword       | Password (From email)                          |
| SmtpServer         | Server from which you want to send the email.  |
| Smptport           | As per servers                                 |
We are using basic authentication, so we have to mention `smtpusername` and password.

```xml
<target name="sendMail" xsitype="Mail"
    subject="Application Error Log"
    to="XXXXXXXXXXXXXXXXXXXXXXXXXXX"
    from="XXXXXXXXXXXXXXXXXXXXXXXXX"
    body="${longdate}|${message}"
    enableSsl="true"
    smtpAuthentication="Basic"
    smtpServer="smtp.gmail.com"
    smtpUserName="XXXXXXXXXXXXXXXXXXXX"
    smtpPassword="XXXXXXXXXXXXXXXXXXXX"
    smtpPort="587"/>
</targets>
```
### Practical example
---
These are the files I used to configure the logger.
#### Config file
Config file configured to save the log file inside the executable folder with logs formatted as JSONs.

`//nlog.config`
```xml
<?xml version="1.0" encoding="utf-8"?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    autoReload="true"
    throwExceptions="false">
    <targets>
        <target xsi:type="File" name="jsonFile"
            fileName="${processdir}/logs/JSON-LOG${date:format=yyyy-MM-dd}.log">
            <!-- layout="${newline}[${longdate} | ${uppercase:${level}}]${newline}message:
            ${message}${newline}${exception:format=tostring}${newline}" /> -->
            <layout xsi:type="JsonLayout" indentJson="true">
                <attribute name="time" layout="${longdate}" />
                <attribute name="level" layout="${level}" />
                <attribute name="message" layout="${message}" />
                <attribute name="exception" encode="false">
                    <layout xsi:type="JsonLayout">
                        <attribute name="type" layout="${exception:format=type}" />
                        <attribute name="message" layout="${exception:format=message}" />
                        <attribute name="stacktrace" layout="${exception:format=tostring}" />
                    </layout>
                </attribute>
            </layout>
        </target>
    </targets>
    <rules>
        <logger name="*" writeTo="jsonFile" minlevel="Debug" />
    </rules>
</nlog>

```

>[!NOTE]
>The commented instruction is to format the log to a generic log format.
#### Project configuration
In order for this to work, we need to enable the property copy to path of the configuration file. We also need the packages:
- `NLog` - to import the `NLog` logger
- `NLog.StructuredLogging.Json` - to structure the log as a JSON
- `Newtonsoft.Json` - to serialize and deserialize logs into or from JSONs
`//project.csproj | project.vbproj`
```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
    <PackageReference Include="NLog" Version="5.3.4" />
    <PackageReference Include="NLog.StructuredLogging.Json" Version="4.0.0" />
  </ItemGroup>
  <ItemGroup>
    <None Update="nlog.config">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </None>
  </ItemGroup>

</Project>

```

>[!NOTE]
>`CopyToOutputDirectory` is the property to copy the config file in the executable directory. `PreserveNewest` is to always update only on changes.

Useful commands from terminal:
- *To add packages in terminal: `dotnet add package packageName`*
- *To create a console project: `dotnet new console -n projName`*
- *To create a VB console project: `dotnet new console - lang "VB" -n projName`*
#### Code
This is only a test of what can be done:

`//Program.cs`
```cs
using NLog;
using NLog.StructuredLogging.Json;

namespace NLogTest
{
    class Program
    {
        // creating a logger instace to log things
        private static Logger log = LogManager.GetCurrentClassLogger();

        static void Main(string[] args)
        {
            // in the configuration file i've set it to create the logs in a directory without specifying the full path
            // this means that the directory with all the logs will be created in the directory with the executable (in bin)
            Console.WriteLine("Hello World!");
            try
            {
                log.ExtendedInfo("This is an info message to test");
                Console.WriteLine("this means that it went well");
            }
            catch (Exception e)
            {
                log.Debug(e, "This is a debug message to test");
                Console.WriteLine("this means that it got fucked");
            }
            NLog.LogManager.Shutdown(); // flush and close down internal threads and timers
        }
    }
}

```
#### Output
This will be the output of this operation:

```fileTree
  ~/CodeVim/CS/NLogTest
    bin
   └  Debug
     └  net8.0
       │  logs
       │ │ 󰌱 JSON-LOG2025-01-15.log
       │ * NLog.StructuredLogging.Json.d
       │ * NLog.dll
       │ * NLogTest
       │  NLogTest.deps.json
       │ * NLogTest.dll
       │ * NLogTest.pdb
       │  NLogTest.runtimeconfig.json
       │ * Newtonsoft.Json.dll
       └ * nlog.config
    obj
   󰪮 NLogTest.csproj
   󰌛 Program.cs
   * nlog.config
```

`//JSON-LOG2025-01-15.log`
```log
{
  "time": "2025-01-15 10:21:22.4313",
  "level": "Debug",
  "message": "This is a debug message to test",
  "exception": { "type": "System.DivideByZeroException", "message": "Attempted to divide by zero.", "stacktrace": "System.DivideByZeroException: Attempted to divide by zero.\n   at NLogTest.Program.Main(String[] args) in /home/qq/CodeVim/CS/NLogTest/Program.cs:line 20" }
}
{
  "time": "2025-01-15 10:22:02.4159",
  "level": "Info",
  "message": "This is an info message to test"
}
```
### Google Cloud Logging
---
To use this logger with `NLog` we need to use another package: `Google.Cloud.Logging.NLog`.

Which will enable us to log things to google cloud. There are different levels of severity:
- Trace - the most detailed level with the most information
- Debug - used for debugging messages that are less detailed but still useful
- Info - used for general informational messages that highlight the progress of the application at a high level
- Warn - indicates potential problems or situations that may require attention
- Error - used when an error occurs that might allow the application to continue running but indicates a failure in a specific operation
- Fatal - the highest severity that indicates a very serious error that could very well terminate the application
#### Configuration
With this package we need to use a file of configuration named `nlog.xml` instead, which is practically the same as the one used in the `NLog` library, but it has some differences.

We still need to copy the configuration to output directory, either with the method above or this:

```xml
<None Update="nlog.xml" CopyToOutputDirectory="Always" />
```

In every instances I found they add a new section almost at the start of the configuration:

```xml
<extensions>
	<add assembly="Google.Cloud.Logging.NLog" />
</extensions>
```

Then we have in the targets a new type and a context property in our case:

```xml
<target name="stackdriver" xsi:type="GoogleStackdriver"
		projectId="repoName" logId="oweb (in our case)"
		includeEventProperties="true" sendJsonPayload="true" 
		EnableJsonLayout="true">
	<contextproperty name="appid" layout="oweb"/>
	<layout xsi:type="JsonLayout" includeAllProperties="true">
		<!-- ... -->
	</layout>
</target>
<!-- ... -->
<rules>
	<logger name="*" writeTo="stackdriver" minlevel="Debug" />
	<logger name="*" writeTo="console" minlevel="Info" />
</rules>
```

The section `<contextproperty>` allows us to define custom properties that are included in the log event context.

Then from the code we need to specify that we are using this specific configuration file:
#### Set up
```cs
// configuring to use this specific config file
LogManager.Setup().LoadConfigurationFromFile("nlog.xml", optional: false);

// instance the logger as an object
Logger log = LogManager.GetCurrentClassLogger();

// flush the logger and then shut it down before the program exits
LogManager.Flush(TimeSpan.FromSeconds(15));
LogManager.Shutdown();
```

Then in the configuration file given by my tutor there are also some properties to add to the configuration i cannot see the logs. Because `NLog` manages exceptions by itself and so it does not show the errors in the debug of the program:
#### Debugging 
```
internalLogLevel="Debug" 
internalLogToConsole="true"
throwConfigExceptions="true"
internalLogFile="c:\temp\nlog-internal.txt"
```

These properties allows `NLog` to actually create another log file for the logs that `NLog` creates whenever the process of creating the log fails and this file, as the property says, is created in `c:\temp\nlog-internal.txt`.

>[!NOTE]
>In order to write to `Stackdriver` (Google cloud logs), you have to use this command on the console first: `gcloud auth application-default login`, of course you will need to install `gcloud` first (from `winget` if you're in windows or whatever package manager you use to install shit from the console).

Command given if there is an error showing up when logging in with `gcloud`: `gcloud auth application-default set-quota-project` to add a quota project. 

Warning given: 
WARNING: Cannot add the project "sigemi-dev-01" to ADC as the quota project because the account in ADC does not have the `"serviceusage.services.use"` permission on this project. You might receive a `"quota_exceeded"` or `"API not enabled"` error.

Current configuration for my exercise of day 3 advent of code 2024:

```xml
<?xml version="1.0" encoding="utf-8"?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    autoReload="true"
    throwExceptions="true"
    internalLogLevel="Debug"
    internalLogToConsole="true"
    throwConfigExceptions="true"
    internalLogFile="D:\Guevarra\VisualStudioProjects\Esercizi\NLogs\internal-logs-day3.txt">

	<extensions>
		<add assembly="Google.Cloud.Logging.NLog" />
	</extensions>

	<targets async="false">
		<target xsi:type="GoogleStackdriver" name="stackdriver"
            projectId="sigemi-dev-01" logId="localPrjTest"
            includeEventProperties="true" sendJsonPayload="true"
            EnableJsonLayout="true">
			<layout xsi:type="JsonLayout" indentJson="true">
				<attribute name="appId" layout="localTest1" />
				<attribute name="time" layout="${longdate}" />
				<attribute name="level" layout="${uppercase:${level}}" />
				<attribute name="message" layout="${message}" />
				<attribute name="exception" encode="false">		
					<layout xsi:type="JsonLayout">
						<attribute name="type" layout="${exception:format=type}" />
						<attribute name="message" layout="${exception:format=message}" />
						<attribute name="stacktrace" layout="${exception:format=tostring}" />
					</layout>
				</attribute>
			</layout>
		</target>
		<target xsi:type="Console" name="console">
			<layout xsi:type="JsonLayout" indentJson="true">
				<attribute name="appId" layout="localTest1" />
				<attribute name="time" layout="${longdate}" />
				<attribute name="level" layout="${uppercase:${level}}" />
				<attribute name="message" layout="${message}" />
				<attribute name="exception" encode="false">
					<layout xsi:type="JsonLayout">
						<attribute name="type" layout="${exception:format=type}" />
						<attribute name="message" layout="${exception:format=message}" />
						<attribute name="stacktrace" layout="${exception:format=tostring}" />
					</layout>
				</attribute>
			</layout>
		</target>
	</targets>
	<rules>
		<logger name="*" writeTo="stackdriver" minlevel="Debug" />
		<logger name="*" writeTo="console" minlevel="Info" />
	</rules>
</nlog>

```