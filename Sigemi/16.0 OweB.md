### `eXstasia`
---
Framework che sta sotto `Oweb`, ovvero quello su cui e' stato costruito nel 2006 piu' o meno. 

Piattaforma low code -> framework che consentono di comporre dei prodotti scrivendo meno codice, con elementi gia' fatti ma che possiamo sempre personalizzare via codice `VB .Net Framework`. 

`eXStasia` e' una piattaforma low code.
### Esercitazione
---
1. Censimento Degli Open ETL Entity relationship in `DB Oweb Data`.
	- Id usato in `SelfAdmin` (usato per associare il servizio all'ETL)
	- Descrizione 
	- Tipologia di flusso
	- Se e' custom o no (chiedere cosa significa)
	- Data di attivazione (richiedono l'ID del servizio)
	- Cliente (richiedono l'ID del servizio)
2. Generazione di grid/filter/form su `Oweb`.

ETL: 
- Sorgente 
- Destinazione
- Trasformazione che puo' essere null

`src` e `dst` possono essere anche chiamati `tipo` perche' sono anche categorizzati tramite essi (`sql-to-bq`, `rest-to-bq`, ....)

Struttura DB da realizzare (Forse giusto o no non ne ho idea)

Entities:
- `ETL_TipiFlussi`
	- `ID_Tipologia`
	- Tipo
		- SQL-Copy v2
		- SQL-Copy
		- SFTP-Copy
	- Descrizione
		- Un Flusso `OpenETL` SQL-Copy v2 prevede l'esecuzione di una sequenza di trasferimenti: Esecuzione di una query tipicamente SELECT su un database sorgente, in seguito avviene la creazione di una tabella temporanea in cui vengono fatte le operazioni di merge tra la tabella presente su BQ e il risultato della nostra SELECT. E finalmente si fa un drop sulla tabella presente su BQ e se ne crea una nuova dove si fa un insert into di tutti i nuovi dati, Cosi' facendo si riuscira' ad evitare lo streaming buffer.
		- Un Flusso `OpenETL` SQL-Copy v2 prevede questi passi: Esecuzione di una query tipicamente SELECT su un database sorgente, Per ogni record estratto eseguire una query, tipicamente una INSERT o un UPDATE su un database di destinazione che fa riferimento ai valori estratti dalla prima select. L'esecuzione viene avviata tramite un'espressione CRON.
		- Un flusso `OpenETL` SFTP-copy prevede questi passi: Recupero di file da una “sorgente” con vari protocolli possibili tra i quali: SFTP, FTP, ecc., Decriptazione opzionale dei file recuperati nel caso questi siano stati criptati con PGP, Salvataggio dei file recuperati in una “destinazione” con vari protocolli possibili tra i quali: SFTP, FTP, ecc. Il recupero dei file sorgenti avviene tipicamente tramite polling, essa e' in deploy come una applicazione singola in GKE nel progetto `sigemi-prod` e gestisce tutti i flussi SFTP copy di tutti i clienti che ne fanno uso.
- `ETL_Flussi`
	- `ID_Flusso`
	- `Nome_Flusso`
		- flusso1
		- flusso2
		- flusso3
		- flusso4
	- `ID_Tipologia`
	- `ID_Organization` (Cliente)
	- `DataAttivazione`

Query per prendere tutti i servizi attivi con il proprio cliente associato, insieme alla data di attivazione del servizio (Meglio utilizzare quello gia' creato - `dbo.vw_SERV_Service_Edit` - che contiene gia' tutti i dati che mi servono):

```sql
Select DISTINCT
	ID_Service,
	ServiceName, 
	Variant,
	Organization, 
	StatusDate as LastACtivated, 
	CurrentStatus

FROM(
	SELECT 
		serv.ID_Service,
		serv.ID_ServiceReplaced,	
		cat.Name as ServiceName, 
		varnt.Description as Variant,
		orgs.Description as Organization, 
		serv.StatusDate, 
		stat.Description as CurrentStatus, 
		RANK() OVER(
			PARTITION BY cat.Name, orgs.Description, varnt.Description
			Order by serv.StatusDate DESC
		) as servRank

	FROM
		dbo.SERV_Service as serv
	
		INNER JOIN dbo.SERV_Status as stat
			ON serv.ID_Status = stat.ID_Status

		INNER JOIN dbo.CRM_Organizations as orgs
			ON serv.OrganizationID = orgs.OrganizationID

		INNER JOIN dbo.SERV_ServiceCatalog as cat
			ON serv.ID_ServiceCatalog = cat.ID_ServiceCatalog

		LEFT JOIN dbo.SERV_Variant as varnt
			ON serv.ID_Variant = varnt.ID_Variant

		LEFT JOIN dbo.SERV_Service as tmp
			ON serv.ID_Service = tmp.ID_ServiceReplaced 
	WHERE 
		tmp.ID_ServiceReplaced IS NULL 
		-- This has to search if it is null 
		-- since we're doing a left join between
		-- ID_Service and ID_ServiceReplaced
		-- in order to find the services that have not been replaced
		-- because they are most likely the latest ones

) as x

WHERE 
	servRank = 1
	AND CurrentStatus Like('Attivo%')

ORDER BY ServiceName, Organization
```

Flussi su Workload:

| Flusso                                              | Tipo         | Spazio dei Nomi | cluster         |
| --------------------------------------------------- | ------------ | --------------- | --------------- |
| archdb-export                                       | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| cdg-datawarehouse-export                            | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| cdg-test-export<br>                                 | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| conpay-piadineria                                   | Cron Job     | etl-services    | gke-sigemi-prod |
| consuntivi-gcp-oweb-cronjob                         | Cron Job     | etl-services    | gke-sigemi-prod |
| contracts-alpha-2-zcs                               | Cron Job     | etl-services    | gke-sigemi-prod |
| contracts-hrz-2-zcs                                 | Cron Job     | etl-services    | gke-sigemi-prod |
| crm-csv-zucchetti                                   | Stateful Set | datapeople-dev  | gke-sigemi-prod |
| crm-csv-zucchetti                                   | Stateful Set | etl-services    | gke-sigemi-prod |
| dettaglio-crm-ricarica-da-sftp                      | Deployment   | etl-services    | gke-sigemi-prod |
| dettaglio-crm-ricarica-da-sftp                      | Deployment   | datapeople-dev  | gke-sigemi-prod |
| dettaglio-crm-webservice                            | Cron Job     | etl-services    | gke-sigemi-prod |
| dettaglio-crm-webservice                            | Cron Job     | datapeople-dev  | gke-sigemi-prod |
| dev-datapeople-hrz-sql-risorse-wf                   | Cron Job     | datapeople-dev  | gke-sigemi-prod |
| etl-bluedental-to-jobcode                           | Stateful Set | etl-services    | gke-sigemi-prod |
| etl-cerba-to-jobcode                                | Stateful Set | etl-services    | gke-sigemi-prod |
| etl-gmsystem20-edoc-to-ago                          | Stateful Set | etl-services    | gke-sigemi-prod |
| etl-gmsystem20-edoc-to-ago-rendicontazione-cbi      | Cron Job     | etl-services    | gke-sigemi-prod |
| etl-gmsystems20-corrispettivi                       | Stateful Set | etl-services    | gke-sigemi-prod |
| etl-spaziopro-ago-to-datasmart-fai                  | Cron Job     | etl-services    | gke-sigemi-prod |
| etl-spaziopro-ago-to-datasmart-gmsystem             | Cron Job     | etl-services    | gke-sigemi-prod |
| eurospin-export                                     | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| gamma-stl-export                                    | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| gcp-consuntivi-attivi-export                        | Cron Job     | etl-services    | gke-sigemi-prod |
| gcp-consuntivi-matching-value-export                | Cron Job     | etl-services    | gke-sigemi-prod |
| lansweeperdb-export                                 | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| muscope-assets-export                               | Cron Job     | etl-services    | gke-sigemi-prod |
| muscope-export-selfadmin-test                       | Cron Job     | etl-services    | gke-sigemi-prod |
| muscope-summary-export                              | Cron Job     | etl-services    | gke-sigemi-prod |
| one-vw-lansweeper-export                            | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| sql-copy-datapeople-dev-hrz-rdl-workflow            | Cron Job     | datapeople-dev  | gke-sigemi-prod |
| sql-copy-datapeople-dev-hrz-risorse-workflow        | Cron Job     | datapeople-dev  | gke-sigemi-prod |
| sql-copy-datapeople-dev-infinity-flusso-gestio      | Cron Job     | datapeople-dev  | gke-sigemi-prod |
| sql-copy-datapeople-dev-infinity-risorse-gestionale | Cron Job     | datapeople-dev  | gke-sigemi-prod |
| sql-copy-datapeople-hrz-azienda-workflow            | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-hrz-budget-timesheet-workflow   | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-hrz-consuntivi-gtl-workflow     | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-hrz-costi-orari-workflow        | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-hrz-presenze-workflow           | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-hrz-rdl-workflow                | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-hrz-risorse-workflow            | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-infinity-flusso-gestio          | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-datapeople-infinity-risorse-gestionale     | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-eurotranciatura-anag-dipendenti            | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-eurotranciatura-idoneita                   | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-eurotranciatura-ore-lavorate               | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-eurotranciatura-ore-lavorate-oneshot       | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-eurotranciatura-ruoli                      | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-eurotranciatura-safety                     | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-eurotranciatura-timbrature                 | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-hsc-cdg-standard01                         | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-hsc-cdg-timetravel01                       | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-hsc-export-gamma                           | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-centri-di-costo-1               | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-ord-serv                        | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-ord-serv-disd                   | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-ord-serv-part                   | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-prj-entry-log-not-billed        | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-prjgmt                          | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-standard01                      | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-cdg-timetravel01                    | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-presenze                            | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-ratei                               | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-risorse                             | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-sigemi-timbrature                          | Cron Job     | etl-services    | gke-sigemi-prod |
| sql-copy-studio-donati                              | Cron Job     | etl-services    | gke-sigemi-prod |
| studio-donati-export                                | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| test-sql-copy-multimage                             | Cron Job     | datapeople-dev  | gke-sigemi-prod |
| xts-data-export                                     | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| xts-vehicles-export                                 | Cron Job     | sql-to-bq       | gke-sigemi-prod |
| xtsdata-sigemi-export                               | Cron Job     | sql-to-bq       | gke-sigemi-prod |

Possibile struttura DB (probabilmente sbagliato, ho ancora troppo poche informazioni su come poter abbinare i dati dei servizi e clienti con i flussi in se')

![[Screenshot 2025-01-23 123730.png]]

**ETL Flusso custom:** 
- Non e' custom quando una infrastruttura gia' pronta con apache camel che ha una serie di parametrizzazioni in un file apposta.
- Diventa custom quando richiede uno sviluppatore per modificare una parte del flusso perche' manca una funzionalita' nella struttura base del flusso.

Tipologie di flussi industrializzati Dipendono dall'origine dei dati:
- `sql-to-bq` con una query eseguito su un impianto `sql` da cui estraiamo i dati per poi tradurli e portarli su `bq`
- `rest-to-bq` va ad effettuare una chiamata API a Cassiopea CRM e attraverso un codice di esportazione, l'API manda 200 se il codice e' corretto e possiamo estrarre i dati, ed infine estraiamo i dati in formato JSON che verranno poi interpretati e parsed.
- `sftp-to-bq` quando l'origine dei dati non e' direttamente estraibile da una fonte o un sistema, in questo caso c'e' un'ambiente sftp dove il cliente puo' fare un upload dei dati attraverso un file CSV o JSON che poi estraiamo, interpretiamo e $parsiamo$ per poi inserire i dati su BQ (con tutto il procedimento di tabelle temporanee per lo streaming buffer).
- `sftp copy` fanno ancora uso delle delete insert

Flussi Custom:
- Flusso prestazioni (le nostre note intervento), non esiste un ID univoco (stronzi) con cui fare una merge e ci mandano solo il mese corrente e precedente.

`SelfAdmin` fa uso dell'id del Cron Job (Stateful set -> costantemente attivo per polling in `sftp`)

query teoricamente giusta:

```sql
SELECT ID_Flow, 
	Name,
	ty.Type, 
	serv.DateFirstActive,
	ID_SelfAdmin,
	flow.ID_Service, 
	serv.ServiceCatalog,
	flow.ID_Customer, 
	orgs.Description as Customer, 
	IsCustom, 
	ReasonIsCustom, 
	RepoURL

	FROM dbo.ETL_Flow as flow

	LEFT JOIN dbo.ETL_FlowType as ty
		on flow.ID_Type = ty.ID_Type

	LEFT JOIN dbo.vw_SERV_Service_Edit as serv
		on flow.ID_Service = serv.ID_Service

	LEFT JOIN dbo.CRM_Organizations as orgs
		on flow.ID_Customer = orgs.OrganizationID


```